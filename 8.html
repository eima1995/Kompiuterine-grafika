<!DOCTYPE html>
<html>
<head>
</head>
  <body>
    <canvas id="myCanvas" width="1000" height="1000"></canvas>
    <script>
      window.requestAnimFrame = (function(callback) {
        return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
        function(callback) {
          window.setTimeout(callback, 1000 / 60);
        };
      })();
      function draw(myLink, ctx) {
        ctx.beginPath();
        ctx.rect(-myLink.off, -myLink.off, myLink.width+2*myLink.off, 2*myLink.off);
        ctx.fillStyle = myLink.color;
        ctx.fill();
        ctx.lineWidth = myLink.borderWidth;
        ctx.strokeStyle = 'black';
        ctx.stroke();
        ctx.beginPath();        
        ctx.arc(0,0,myLink.borderWidth/2,0,Math.PI*2,true);
        ctx.fillStyle = 'white';
        ctx.fill();
        ctx.beginPath();        
        ctx.arc(myLink.width,0,myLink.borderWidth/2,0,Math.PI*2,true);
        ctx.fillStyle = 'white';
        ctx.fill();
      }
      function animate(aLink, bLink, cLink, dLink, efLink,beLink, ceLink, bfLink, canvas, ctx, startTime) {
         // update
        var time = (new Date()).getTime() - startTime;
        var t = time / 50;
        
		
		// TODO: pradzia pakeisti nepatinka man jinai.
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // store initial coordinates
        ctx.save(); // [M0]
        ctx.save(); // [M0,M0]
        ctx.translate(canvas.width/2+100,canvas.height/2);
		var th1 = Math.PI/180*t
		ctx.rotate(th1); 
		
        ctx.restore();  // M0 [M0]		
        ctx.translate(canvas.width/2-100,canvas.height/2);
		ctx.save();  // [M1,M0]
		ctx.save();
		alpha = -th1;
		ctx.rotate(alpha);
		draw(aLink, ctx);
		
        var BD = Math.sqrt(aLink.width*aLink.width + cLink.width*cLink.width - 2*aLink.width*cLink.width*Math.cos(alpha));
		var theta = angle(BD,aLink.width,cLink.width); //ABD
		var beta = angle(cLink.width, BD, aLink.width); //ADB
		var gamma = angle(aLink.width,cLink.width,BD); //DAB
		var delta = angle(BD, bLink.width, aLink.width); //ADC
		var tau = angle(BD, aLink.width, bLink.width);
	
	    ctx.translate(aLink.width,0); // kad galima butu kabinti BC
		
		// trikampio skaiciavimai
		var BE = Math.sqrt(bfLink.width * bfLink.width + efLink.width * efLink.width); // BF^2 + EF^2
		var ebf = angle(BE,bfLink.width,efLink.width);// EBF
		var FC = aLink.width - bfLink.width;
		ceLink.width = Math.sqrt(efLink.width * efLink.width + FC * FC); // EF^2 + EC^2
		var fce = angle(FC, ceLink.width, efLink.width); // FCE
		
	    if (((th1)%(Math.PI*2)) > Math.PI){
		// uz apacios veikima atsakingas
			ctx.rotate(Math.PI + theta);
			dLink.width = BD; // galim priskirti kadangi, niekam nera priskirtas
			console.log("Theta" + theta);
			draw(dLink, ctx); // zalia BD piesia
			ctx.rotate(-tau);	///////// speju negeras kampas
		
		 	draw(aLink, ctx);  // BC
			ctx.save();
			draw(bfLink,ctx);       // BF (turetu buti reguliuojamas)
			
			ctx.save();
			ctx.rotate(-ebf);
			beLink.width = BE;
			draw(beLink,ctx);
			ctx.restore();
			
			ctx.save();
			ctx.translate(bfLink.width,0);
			ctx.rotate(-Math.PI/2);
			draw(efLink,ctx);   // EF
			ctx.restore();
	
			ctx.translate(aLink.width,0);
			ctx.rotate(Math.PI + fce);
            draw(ceLink, ctx); // CE piesia

		}else{ // virsaus veikimas
		    ctx.save();
		    ctx.rotate(Math.PI - theta); //PI - theta
			dLink.width = BD;
		   	draw(dLink, ctx);// BD piesia
			ctx.restore();
			ctx.rotate(-(theta + tau) + Math.PI);
			draw(aLink, ctx); // BC
			draw(bfLink,ctx);       // BF (turetu buti reguliuojamas)
			
			ctx.save();
			ctx.rotate(-ebf);
			beLink.width = BE;
			draw(beLink,ctx);
			ctx.restore();
			
			ctx.save();
			ctx.translate(bfLink.width,0);
			ctx.rotate(-Math.PI/2);
			draw(efLink,ctx);   // EF
			ctx.restore();
	
			ctx.translate(aLink.width,0);
			ctx.rotate(Math.PI + fce);
            draw(ceLink, ctx); // CE piesia
		
		}
		
		ctx.restore();  // M0 [M0]		
		
        ctx.restore(); // M1 [M0] 
        draw(cLink, ctx); // AD
        
		
		
	
		if (((th1)%(Math.PI*2)) > Math.PI){ //apacioje AB
			//console.log("PSI" + psi);
		    var psi = Math.PI + (beta - delta);
		    psi = -psi;
			ctx.translate(cLink.width, 0);
			ctx.rotate(psi);
			draw(bLink, ctx); // DC
		}else{ // virsus
			// DC piesimas
			var psi = Math.PI - beta - delta;
			psi = -psi;
			ctx.translate(cLink.width, 0);
			ctx.rotate(psi);
			draw(bLink, ctx); // DC
	    }
	
        ctx.restore(); // M0 [] 
        ctx.restore(); // M0 [] 
        requestAnimFrame(function() {
          animate(aLink, bLink, cLink, dLink, efLink, beLink, ceLink, bfLink, canvas, ctx, startTime);
        });
      }
	  
	  
	  function angle(a, b, c){
			return Math.acos((a * a + b * b - c * c) / (2*a*b));
      }  
	  
      var canvas = document.getElementById('myCanvas');
      var ctx = canvas.getContext('2d');
      var aLink = {  // AB, BC
        color: '#8ED6FF',
        width: 200,
        off: 10,
        borderWidth: 4
      };
      var bLink = { // CD
        color: '#FF8ED6',
        width: 250,
        off: 10,
        borderWidth: 4
      };
	  
	  var cLink = { // AD
        color: 'green',
        width: 150,
        off: 10,
        borderWidth: 4
      };
      var dLink = { // BD 
		color: 'cyan',
		width: 100,
		off: 10,
       borderWidth: 4
      };
	  
	  var bfLink = { // BF
		color: 'cyan',
		width: 100,
		off: 10,
       borderWidth: 4
      };
	  
	  
	  var efLink = { // EF
		color: 'cyan',
		width: 200,
		off: 10,
       borderWidth: 4
      };
	  
	 var beLink = { // BE
		color: 'cyan',
		width: 100,
		off: 10,
       borderWidth: 4
      };
	 
	var ceLink = { // CE
		color: 'cyan',
		width: 100,
	    off: 10,
       borderWidth: 4
      };
	  
      //draw(myLink, ctx);
      // wait one second before starting animation
//      setTimeout(function() {
        var startTime = (new Date()).getTime();
        animate(aLink, bLink, cLink, dLink, efLink, beLink, ceLink, bfLink, canvas, ctx, startTime);
//      }, 1000);
    </script>
</body>
</html>
